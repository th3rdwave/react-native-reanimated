{"version":3,"names":["scheduleUpdates","shouldBeUseWeb","requestAnimationFrame","setImmediate","makeViewDescriptorsSet","ref","useRef","current","data","batchToRemove","Set","tags","waitForInsertSync","waitForRemoveSync","sharableViewDescriptors","makeMutable","items","add","item","has","tag","push","value","remove","viewTag","delete","rebuildsharableViewDescriptors","makeViewsRefSet"],"sources":["ViewDescriptorsSet.ts"],"sourcesContent":["import { useRef } from 'react';\nimport { makeMutable } from './core';\nimport { SharedValue } from './commonTypes';\nimport { Descriptor } from './hook/commonTypes';\nimport { shouldBeUseWeb } from './PlatformChecker';\n\nexport interface ViewRefSet<T> {\n  items: Set<T>;\n  add: (item: T) => void;\n  remove: (item: T) => void;\n}\n\nexport interface ViewDescriptorsSet {\n  batchToRemove: Set<number>;\n  tags: Set<number>;\n  waitForInsertSync: boolean;\n  waitForRemoveSync: boolean;\n  sharableViewDescriptors: SharedValue<Descriptor[]>;\n  items: Descriptor[];\n  add: (item: Descriptor) => void;\n  remove: (viewTag: number) => void;\n  rebuildsharableViewDescriptors: (\n    sharableViewDescriptor: SharedValue<Descriptor[]>\n  ) => void;\n}\n\nconst scheduleUpdates = shouldBeUseWeb() ? requestAnimationFrame : setImmediate;\n\nexport function makeViewDescriptorsSet(): ViewDescriptorsSet {\n  const ref = useRef<ViewDescriptorsSet | null>(null);\n  if (ref.current === null) {\n    const data: ViewDescriptorsSet = {\n      batchToRemove: new Set(),\n      tags: new Set(),\n      waitForInsertSync: false,\n      waitForRemoveSync: false,\n      sharableViewDescriptors: makeMutable([]),\n      items: [],\n\n      add: (item: Descriptor) => {\n        if (data.tags.has(item.tag)) {\n          return;\n        }\n        data.tags.add(item.tag);\n        data.items.push(item);\n\n        if (!data.waitForInsertSync) {\n          data.waitForInsertSync = true;\n\n          scheduleUpdates(() => {\n            data.sharableViewDescriptors.value = data.items;\n            data.waitForInsertSync = false;\n          });\n        }\n      },\n\n      remove: (viewTag: number) => {\n        data.batchToRemove.add(viewTag);\n\n        if (!data.waitForRemoveSync) {\n          data.waitForRemoveSync = true;\n\n          scheduleUpdates(() => {\n            const items = [];\n            for (const item of data.items) {\n              if (data.batchToRemove.has(item.tag)) {\n                data.tags.delete(item.tag);\n              } else {\n                items.push(item);\n              }\n            }\n            data.items = items;\n            data.sharableViewDescriptors.value = items;\n            data.batchToRemove = new Set();\n            data.waitForRemoveSync = false;\n          });\n        }\n      },\n\n      rebuildsharableViewDescriptors: (\n        sharableViewDescriptors: SharedValue<Descriptor[]>\n      ) => {\n        data.sharableViewDescriptors = sharableViewDescriptors;\n      },\n    };\n    ref.current = data;\n  }\n\n  return ref.current;\n}\n\nexport function makeViewsRefSet<T>(): ViewRefSet<T> {\n  const ref = useRef<ViewRefSet<T> | null>(null);\n  if (ref.current === null) {\n    const data: ViewRefSet<T> = {\n      items: new Set(),\n\n      add: (item: T) => {\n        if (data.items.has(item)) return;\n        data.items.add(item);\n      },\n\n      remove: (item: T) => {\n        data.items.delete(item);\n      },\n    };\n    ref.current = data;\n  }\n\n  return ref.current;\n}\n"],"mappings":"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"}